#!/bin/sh

# ZSH aliases and functions file

alias cat="/usr/share/ccat/ccat -G String='darkgreen' -G Plaintext='blue' -G Comment='darkyellow' -G HTMLTag='purple' -G Literal='darkred' -G Tag='Fuscia'"
alias ls="colorls"
alias xclip="xclip -selection c"

gx() {
    read -k $'?Remove all files ignored by Git? [Y/n]: ' clean
    if [ "${clean}" = "Y" ] || [ "${clean}" = "y" ]; then
        git clean -f -X $1
    fi
}

gxh() {
    git clean -d -n $1
    read -k $'?Remove all untracked files and directories? [Y/n]: ' clean
    if [ "${clean}" = "Y" ] || [ "${clean}" = "y" ]; then
        git clean -f -d $1
    fi
}

# Git aliases
alias ga="git add"
alias gaa="git add -A"
alias gb="git branch"
alias gx="gx"
alias gxh="gxh"
alias gc="git commit -m"
alias gca="git commit -am"
alias gch="git checkout"
alias gcl="git clone"
alias gd="git diff"
alias gdh="git diff HEAD"
alias gds="git diff --staged"
alias gf="git fetch"
alias gl="git log"
alias gp="git push origin"
alias gpl="git pull origin"
alias gr="git reset"
alias grh="git reset --hard"
alias gt="git stash"
alias gtp="git stash pop"
alias gst="git status"

# print all Git aliases
alias galias="alias | grep \"='git \" --color=never"

# change directory to the last directory a file or directory was copied or moved to
cdthere() {
  cd "$(history | grep "mv\|cp" | tail -n1 | grep -oE '[^ ]+$')";
}

# print last errno
eno() {
  _e=$(($(echo $?)))
  [ ${_e} -ne 0 ] && { [ ${_e} -le 134 ] && errno ${_e} || echo "${_e} Unknown error" } || true
}

gui() {
  [ -z "$1" ] && xdg-open . &>/dev/null || xdg-open $1 &>/dev/null;
}

# highlight - colored grep
hl() {
  grep --color -iE "$1|$" "${@:2}";
}

# open a PDF file with the evince viewer
pdf() {
  evince "$@" &>/dev/null & disown;
}

strc() {
  { { grep -src"${3}" ${1} ${2} } || { echo "String not found"; return; } } | grep -v ":0$"
}

strs() {
  { grep -srn"${3}" ${1} ${2} -C ${4:-5} } || echo "String not found"
}

strr() {
  blue=$(tput setaf 4)
  normal=$(tput sgr0)
  find . -type f -printf "\n${blue}%p${normal}:\n" -exec sed --quiet "/${1}/{
  h
  s//${2}/g
  H
  x
  s/\n/ >>> /
  w /dev/fd/2
  x
  }" {} \;
  read -k $'?\nApply changes [Y/n]? ' apply
  if [ "${apply}" = "Y" ] || [ "${apply}" = "y" ]; then
    find . -type f -exec sed -i "s/${1}/${2}/g" {} \;
  fi
}

# compare files to check if they are linked
sameln() {
  _in=$(stat ${1} -c%i)
  [ ${_in} -eq $(stat ${2} -c%i) ] && echo "${1} and ${2} are links (Inode: ${_in})" ||
  echo "${1} and ${2} are not links"
}

unmv() {
  files=$(history | grep "mv" | tail -n1 | awk -F"mv" '{print $(NF)}')
  mv $(echo $files | cut -f3 -d' ') $(echo $files | cut -f2 -d' ')
}

# update system
update() {
  sudo apt update -y && sudo apt upgrade -y && sudo apt autoremove -y && sudo apt autoclean -y
  cd $HOME/.dotfiles && [ "$(parse_git_dirty)" = "$ZSH_THEME_GIT_PROMPT_CLEAN" ] &&
  { git pull; ln -f sublime/* $HOME/.config/sublime*/Packages/User/; ln -f zsh/.* $HOME/ } ||
  echo "Uncommitted changes found";
  cd -
}

# Python virtual environment
venv() {
  if [ -d .venv ]; then
    source .venv/bin/activate
  else
    read -k $'?No virtual environment found. Create one? [Y/n]: ' create
    if [ "${create}" = "Y" ] || [ "${create}" = "y" ]; then
      python -m venv .venv && source .venv/bin/activate
    fi
  fi
}
